<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title></title>
  <style>
    :root{ --joy-size: 360px; --joy-border: 1px; --joy-radius: 16px; --joy-pad: 24px; }
    body{ font-family: system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif; padding:16px; background:#f9fafb; }
    h1,h2{ margin-top:20px; }
    input,button{ padding:6px 8px; margin:4px 0; }
    #log{ margin-top:12px; padding:8px; border:1px solid #ddd; height:200px; overflow:auto; background:#fff; border-radius:8px; }
    #joyWrap{ width:var(--joy-size); height:var(--joy-size); border:var(--joy-border) solid #ccc; border-radius:var(--joy-radius); overflow:hidden; display:inline-block; background:#fff; box-sizing:content-box; }
    #joy{ width:var(--joy-size); height:var(--joy-size); display:block; touch-action:none; background:#fff; }
    #videoBox{ margin-top:16px; border:2px solid #ccc; display:inline-block; border-radius:8px; overflow:hidden; }
    #videoBox img{ max-width:640px; display:block; }
    .row{ display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    .panel{ min-width:260px }
    .mono{ font-family:ui-monospace,Menlo,Consolas,monospace; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eee; color:#333; vertical-align:middle; margin-left:6px; }
    .pill.on{ background:#16a34a; color:#fff; }
    .pill.off{ background:#ef4444; color:#fff; }
  </style>
</head>
<body>
  <h1>ğŸ’» RPi é ç«¯æ§åˆ¶èˆ‡å½±åƒä¸²æµ</h1>

  <!-- MQTT æ§åˆ¶ -->
  <h2>MQTT over WebSocket Bridge</h2>
  <div>
    <label>RPi ä½å€ï¼š</label><input id="host" value="192.168.0.169">
    <label>WS åŸ ï¼š</label><input id="port" value="8081" size="5">
    <button id="connectBtn">é€£ç·š</button>
  </div>
  <div>
    <label>è¨‚é–±ä¸»é¡Œï¼š</label><input id="subTopic" value="robot/motor_pwm">
    <button id="subBtn">è¨‚é–±</button>
  </div>
  <div>
    <label>ç™¼ä½ˆä¸»é¡Œï¼š</label><input id="pubTopic" value="robot/motor_pwm">
    <input id="pubPayload" value="Hello from browser (WS)">
    <button id="pubBtn">ç™¼é€</button>
  </div>
  <div id="log"></div>

  <!-- Joystick + å¸å¡µæ§åˆ¶ -->
  <h2>ğŸ® è™›æ“¬æ–æ¡¿æ§åˆ¶ï¼ˆPWMï¼‰</h2>
  <div class="row">
    <div>
      <div id="joyWrap"><canvas id="joy"></canvas></div>
      <div style="margin-top:6px; color:#666; font-size:12px;">æ‹–å‹•åœ“é»ï¼šä¸Š=å‰é€²ã€ä¸‹=å¾Œé€€ã€å·¦/å³=è½‰å‘</div>
    </div>

    <div class="panel">
      <div><label>æ§åˆ¶ Topicï¼ˆé¦¬é” + å¸å¡µå…±ç”¨ï¼‰ï¼š</label><input id="joyTopic" value="robot/motor_pwm" style="width:220px"></div>
      <div>
        <label>æœ€å¤§ PWMï¼š</label><input id="maxPwm" type="number" value="255" style="width:80px">
        <label style="margin-left:8px">æ­»å€ï¼š</label><input id="deadzone" type="number" value="0.08" step="0.01" style="width:80px">
      </div>
      <div>
        <label>æ›´æ–°é »ç‡ï¼š</label><input id="hz" type="number" value="25" style="width:80px"> Hz
        <button id="btnStop" style="margin-left:8px">ç·Šæ€¥åœæ­¢</button>
      </div>

      <div id="joyReadout" class="mono" style="margin-top:8px; padding:8px; background:#fff; border:1px solid #eee; border-radius:8px;">
        L:0, R:0<br>v:0.00, Ï‰:0.00<br>vacuum: <span id="vacState" class="pill off">OFF</span>
        <br>ws:<span id="joyWsState">not connected</span>
      </div>

      <!-- å¸å¡µæ§åˆ¶ï¼ˆç”¨åŒä¸€å€‹ Topicï¼Œpayload æœƒå« vacuumï¼‰ -->
      <div style="margin-top:8px;">
        <button id="vacOnBtn">å•Ÿå‹•å¸å¡µï¼ˆvacuum: trueï¼‰</button>
        <button id="vacOffBtn" style="margin-left:6px;">é—œé–‰å¸å¡µï¼ˆvacuum: falseï¼‰</button>
        <button id="vacToggleBtn" style="margin-left:6px;">åˆ‡æ›</button>
        <div style="font-size:12px; color:#666; margin-top:6px;">
          é€å‡ºæ ¼å¼ï¼š<span class="mono">{ "L": number, "R": number, "vacuum": true|false }</span>
        </div>
      </div>
    </div>
  </div>

  <!-- å½±åƒä¸²æµ -->
  <h2>ğŸ“· å³æ™‚å½±åƒä¸²æµ</h2>
  <div id="videoBox">
    <img id="streamImg" src="http://192.168.0.169:8080/?action=stream" alt="å½±åƒä¸²æµè¼‰å…¥ä¸­...">
  </div>

  <script>
    // ===== åŸºæœ¬ WS/MQTT Bridge =====
    let ws = null;
    const log = (s) => { const d=document.getElementById('log'); d.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${s}</div>`; d.scrollTop = d.scrollHeight; };
    const enableControls = on => ['subBtn','pubBtn','btnStop','vacOnBtn','vacOffBtn','vacToggleBtn'].forEach(id=>{ const e=document.getElementById(id); if(e) e.disabled=!on; });

    document.getElementById('connectBtn').onclick = () => {
      const url = `ws://${document.getElementById('host').value.trim()}:${document.getElementById('port').value.trim()}`;
      ws = new WebSocket(url);
      ws.onopen  = () => { log(`âœ… å·²é€£ç·šåˆ° ${url}`); enableControls(true); };
      ws.onclose = () => { log(`âŒ é€£ç·šé—œé–‰`); enableControls(false); };
      ws.onerror = () => { log(`âš ï¸ é€£ç·šéŒ¯èª¤`); };
      ws.onmessage = (ev) => {
        try { const obj = JSON.parse(ev.data); if (obj.type === 'msg') log(`[${obj.topic}] ${obj.payload}`); }
        catch { log(`(raw) ${ev.data}`); }
      };
    };
    document.getElementById('subBtn').onclick = () => {
      if (!ws || ws.readyState !== 1) return log('å°šæœªé€£ç·š');
      const topic = document.getElementById('subTopic').value.trim();
      ws.send(JSON.stringify({ type: 'sub', topic }));
      log(`è¦æ±‚è¨‚é–±ï¼š${topic}`);
    };
    document.getElementById('pubBtn').onclick = () => {
      if (!ws || ws.readyState !== 1) return log('å°šæœªé€£ç·š');
      const topic = document.getElementById('pubTopic').value.trim();
      const payload = document.getElementById('pubPayload').value;
      ws.send(JSON.stringify({ type:'pub', topic, payload }));
      log(`å·²ç™¼ä½ˆåˆ° ${topic}: ${payload}`);
    };
    enableControls(false);

    // ===== æ–æ¡¿ + åŒæ­¥å¸å¡µç‹€æ…‹ï¼ˆåŒ topicï¼‰=====
    const joy = document.getElementById('joy');
    const ctx = joy.getContext('2d');
    const cssJoySize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--joy-size'));
    const cssJoyPad  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--joy-pad')) || 24;
    const dpr = window.devicePixelRatio || 1;
    joy.width  = Math.round(cssJoySize * dpr);
    joy.height = Math.round(cssJoySize * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const geom = () => ({ cx: cssJoySize/2, cy: cssJoySize/2, r: cssJoySize/2 - cssJoyPad });

    const joyTopicEl   = document.getElementById('joyTopic');
    const maxPwmEl     = document.getElementById('maxPwm');
    const deadzoneEl   = document.getElementById('deadzone');
    const hzEl         = document.getElementById('hz');
    const joyWsStateEl = document.getElementById('joyWsState');

    let joyActive=false, joyVec={x:0,y:0}, sendTimer=null;
    let vacOn=false; // å¸å¡µç‹€æ…‹ï¼ˆæœƒè¢«åŒ…å«åœ¨æ¯æ¬¡é€å‡ºçš„ payloadï¼‰
    const vacPill = document.getElementById('vacState');
    const renderVac = ()=>{ vacPill.textContent = vacOn ? 'ON' : 'OFF'; vacPill.classList.toggle('on',vacOn); vacPill.classList.toggle('off',!vacOn); };

    const drawJoy = () => {
      const {cx, cy, r} = geom();
      ctx.clearRect(0,0,cssJoySize,cssJoySize);
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle='#ccc'; ctx.lineWidth=2; ctx.stroke();
      const knobR=16, kx=cx+joyVec.x*r, ky=cy-joyVec.y*r;
      ctx.beginPath(); ctx.arc(kx,ky,knobR,0,Math.PI*2); ctx.fillStyle='#3b82f6'; ctx.fill(); ctx.strokeStyle='#1e3a8a'; ctx.lineWidth=2; ctx.stroke();
    };
    const shape=(s,dz=0.08)=>{ if(Math.abs(s)<dz) return 0; const t=(Math.abs(s)-dz)/(1-dz); return Math.sign(s)*t*t; };
    const vecToLR=(v,w,maxPWM)=>{ let L=v-w,R=v+w; const m=Math.max(1,Math.abs(L),Math.abs(R)); L/=m; R/=m; return { L:Math.round(L*maxPWM), R:Math.round(R*maxPWM) }; };

    let lastLR = {L:0,R:0};
    const sendOnce = ()=>{
      const topic  = joyTopicEl.value.trim();
      const maxPWM = parseInt(maxPwmEl.value||'255');
      const dz     = parseFloat(deadzoneEl.value||'0.08');
      const v = shape(joyVec.y, dz), w = shape(joyVec.x, dz);
      const {L,R} = vecToLR(v,w,maxPWM);
      lastLR = {L,R};

      document.getElementById('joyReadout').innerHTML =
        `L:${L}, R:${R}<br>v:${v.toFixed(2)}, Ï‰:${w.toFixed(2)}<br>vacuum: <span class="${vacOn?'pill on':'pill off'}">${vacOn?'ON':'OFF'}</span>` +
        `<br>ws:<span id="joyWsState">${ws&&ws.readyState===1?'connected':'not connected'}</span>`;

      if (!ws || ws.readyState!==1) return;
      const payload = JSON.stringify({ L, R, vacuum: vacOn });   // åŒä¸€å€‹ topicï¼Œå¸¶ vacuum
      ws.send(JSON.stringify({ type:'pub', topic, payload }));
    };

    const startSend=()=>{ const hz=Math.max(1,parseInt(hzEl.value||'25')); sendTimer=setInterval(sendOnce,1000/hz); };
    const stopSend =()=>{ clearInterval(sendTimer); sendTimer=null; };

    const setVec = (x,y)=>{
      const rect = joy.getBoundingClientRect();
      const {r} = geom();
      const cx = rect.left + cssJoySize/2, cy = rect.top + cssJoySize/2;
      let nx=(x-cx)/r, ny=-(y-cy)/r; const mag=Math.hypot(nx,ny); if(mag>1){ nx/=mag; ny/=mag; }
      joyVec={x:nx,y:ny}; drawJoy();
    };

    joy.addEventListener('pointerdown', e=>{ joy.setPointerCapture(e.pointerId); joyActive=true; setVec(e.clientX,e.clientY); startSend(); });
    joy.addEventListener('pointermove', e=>{ if(joyActive) setVec(e.clientX,e.clientY); });
    const release=()=>{ joyActive=false; joyVec={x:0,y:0}; drawJoy(); sendOnce(); stopSend(); };
    joy.addEventListener('pointerup', release);
    joy.addEventListener('pointercancel', release);
    joy.addEventListener('pointerleave', release);

    document.getElementById('btnStop').onclick = ()=>{ joyVec={x:0,y:0}; drawJoy(); sendOnce(); /* è‹¥è¦åŒæ™‚é—œå¸å¡µï¼Œåœ¨æ­¤æŠŠ vacOn=false; renderVac(); */ };

    // å¸å¡µï¼šä½¿ç”¨åŒä¸€å€‹ topicï¼Œé€å‡º {L,R,vacuum}
    const publishVacNow = ()=>{
      if(!ws || ws.readyState!==1) return log('å°šæœªé€£ç·šï¼Œç„¡æ³•æ§åˆ¶å¸å¡µ');
      const topic = joyTopicEl.value.trim();
      const payload = JSON.stringify({ L:lastLR.L, R:lastLR.R, vacuum: vacOn });
      ws.send(JSON.stringify({ type:'pub', topic, payload }));
      log(`ğŸ§¹ å¸å¡µç‹€æ…‹ â†’ ${vacOn?'ON':'OFF'}ï¼ˆ${topic}ï¼‰`);
    };
    document.getElementById('vacOnBtn').onclick     = ()=>{ vacOn=true;  renderVac(); publishVacNow(); };
    document.getElementById('vacOffBtn').onclick    = ()=>{ vacOn=false; renderVac(); publishVacNow(); };
    document.getElementById('vacToggleBtn').onclick = ()=>{ vacOn=!vacOn; renderVac(); publishVacNow(); };
    window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='v'){ vacOn=!vacOn; renderVac(); publishVacNow(); } });

    drawJoy(); renderVac();
    setInterval(()=>{ joyWsStateEl.textContent=(ws&&ws.readyState===1)?'connected':'not connected'; }, 500);
  </script>
</body>
</html>
